language: python

python:
  - '3.11'

dist: focal

install:
  - pip install -r src/requirements.txt

env:
  global:
    - COVERALLS_FLAG_NAME="Unit Tests"
    - COVERALLS_PARALLEL=true
    - COVERALLS_SERVICE_NAME=travis-ci

script:
  - python src/manage.py makemigrations --check --dry-run
  - black . --check
  - flake8 .
  - PYTHONPATH=. coverage run --source='.' src/manage.py test accounts home public_service_finder services forum

after_success:
  - coveralls debug
  - |
    if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
      echo "Submitting coverage for Pull Request"
      COVERALLS_SERVICE_JOB_ID=$TRAVIS_JOB_ID \
      COVERALLS_SERVICE_BUILD_URL=https://travis-ci.org/$TRAVIS_REPO_SLUG/builds/$TRAVIS_BUILD_ID \
      COVERALLS_SERVICE_PULL_REQUEST=$TRAVIS_PULL_REQUEST \
      coveralls
    else
      echo "Submitting coverage for branch build"
      coveralls
    fi

before_deploy:
  - cd src
  - python manage.py collectstatic --noinput

deploy:
  - provider: elasticbeanstalk
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    region: us-east-1
    app: public-service-finder-dev
    env: public-service-finder-dev-env
    bucket_name: public-service-finder-dev-s3
    on:
      repo: gcivil-nyu-org/wed-fall24-team1
      branch: develop
    cleanup: false

  - provider: elasticbeanstalk
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    region: us-east-1
    app: public-service-finder-prod
    env: public-service-finder-prod-env
    bucket_name: public-service-finder-prod-s3
    on:
      repo: gcivil-nyu-org/wed-fall24-team1
      branch: main
    skip_cleanup: 'true'